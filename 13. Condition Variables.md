# Condition Variables
---
> 예를 들어, 우리는 Child process가 종료되었는지 확인을 하고 Parent Process를 종료시켜야 할 때가 있다.(```Join()```)  
> 그럼 Child Process의 상태를 어떻게 알 것인가?  
> 바로 Condition Variable을 통해서 인지할 수 있다.  

## Example : Parent waiting its child
### Spin based approach  
![image](https://user-images.githubusercontent.com/71700079/167851193-72384610-0915-43fd-8255-3b449904cafd.png)  
- Child가 Done을 1로 만들 때 까지 기다렸다가 Parent를 종료시킨다.
  - 하지만 이 방식은 매우 비효율적이다!
  - 기나긴 Spin-wait는 CPU의 시간낭비!
  - 그럼 어떻게 낭비를 막을 것인가?
### Condition Variable Approach  
![image](https://user-images.githubusercontent.com/71700079/167851543-fc14138b-01fb-49a6-8ebe-2b5cfc76620e.png)  
![image](https://user-images.githubusercontent.com/71700079/167851566-1f237d25-28d3-4bed-a8d4-fe8f9554cc70.png)  
- Main 함수(parent thread)를 보고 생각을 해보자.
- 만약 Parent가 ```Join()``` 을 한 뒤에 Child로 Context Switch가 발생한다면?
  -  Join에 들어가서 ```done```이 아직 0이므로, ```Pthread_cond_wait();```가 실행되어 Child가 끝나기를 기다린다.
  -  Child로 Context Switching이 되며, ```Mutex_lock```을 걸고 ```done```을 1로 바꾼다. 그리고 ```Pthread_cont_signal()```을 통해 Parent를 깨운다.
  -  이후 while문에서 탈출한 parent도 할 일을 하고 종료된다.
- 만약 Parent가 Child를 Create 하자마자 Context Switch 됐다면?
  - 바로 Child에서 Lock이 걸린채로 ```Done```을 1로 바꾸고 ```thr_exit()```를 실행한다.
  - 이후 Parent가 어떤 시점에서 실행되더라도 ```Done```은 1이므로, Parent가 할 일을 끝마치고 종료하면 된다.
- 만약에 ```Done``` Variable이 없다면 어떻게 될까?
  - Child Thread의 상태를 Parent가 알 수가 없다.
  - 위의 예시 둘 중에 Parent가 먼저 실행이 된 경우라면 Signal을 받을 수 있어 상관이 없지만
  - Parent가 늦게 실행되는 경우엔, Signal을 결코 받을 수 없어 영원히 Wait하게 된다.
- 만약에 Lock을 걸지 않는다면 어떻게 될까?
  - ```Done```은 Shared Variable(Critical Sector)이다.
  - 이 부분이 Atomic하게 관리되지 않는다는 의미가 되므로, ```if(done == 0)``` 직후에 Child가 시작된다면?
  - ```Done```을 더 이상 검사하지 않게 되므로, ```Done```이 1로 바뀌었는 지 Parent는 더 이상 알 수 없다.
  - 또 무한한 잠에 빠지게 된다.

## The Producer / Consumer Problem (Bound Buffer)
> Condition Variable에 대한 대표적인 문제인 생산자 소비자 문제이다.  
- Producer
  - Buffer에 Item을 추가하는 역할이다.
- Consumer
  - Buffer에서 Item을 빼가는 역할이다.

- 그런데 Producer이나 Consumer이 여러명일 땐 어떻게 해야할까?

### Broken Solution
![image](https://user-images.githubusercontent.com/71700079/168596252-52c23172-4cf6-4a29-9839-9f0d811e769a.png)  
- 이 예제는, Consumer이 2명일때의 예시이다.
